<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SubTrack</title>

    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231e293b%22/><text x=%2250%22 y=%2268%22 font-family=%22Arial%22 font-size=%2260%22 fill=%22white%22 text-anchor=%22middle%22 font-weight=%22bold%22>S</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SubTrack">

    <style>
        :root {
            /* é…è‰²ã‚’ãƒ¢ãƒãƒˆãƒ¼ãƒ³ã«å¤‰æ›´ */
            --primary: #1e293b; /* æ·±ã„ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            --bg: #fafafa; /* ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ãªç™½ã‚°ãƒ¬ãƒ¼ */
            --card: #ffffff;
            --text: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; line-height: 1.5; }
        
        .header { background: var(--card); padding: env(safe-area-inset-top) 20px 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--text); } /* ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡å­—è‰²ã‚’å°‘ã—è½ã¡ç€ã‹ã›ã¾ã—ãŸ */
        
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }

        /* ãƒœã‚¿ãƒ³ã®è³ªæ„Ÿã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ */
        .btn-sync {
            gap: 8px;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }
        
        .btn-push { background: #6366f1; color: white; }
        .btn-push:hover { background: #4f46e5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        
        .btn-fetch { background: white; border: 1px solid #e2e8f0; color: #64748b; }
        .btn-fetch:hover { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        
        .sync-icon { width: 16px; height: 16px; stroke-width: 2.5; }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼šè‰²æŒ‡å®šã‚’å‰Šé™¤ã—ã¦primaryã‚«ãƒ©ãƒ¼ã«çµ±ä¸€ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .stat-card { background: var(--primary); color: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-label { font-size: 0.7rem; opacity: 0.9; }
        .stat-value { font-size: 1.1rem; font-weight: bold; margin-top: 4px; }

        /* ã‚µãƒ–ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
        .sub-card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: transform 0.1s; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .sub-card:active { transform: scale(0.98); }
        .sub-info .name { font-weight: bold; font-size: 1rem; }
        .sub-info .cycle { font-size: 0.75rem; color: var(--text-sub); }
        .sub-price { text-align: right; font-weight: 700; color: var(--text); }

        /* ã‚¬ã‚¤ãƒ‰è¡¨ç¤º */
        .welcome-guide { background: var(--card); border: 2px dashed var(--border); border-radius: 20px; padding: 30px 20px; text-align: center; margin-top: 20px; }
        .welcome-guide h2 { font-size: 1.1rem; margin-bottom: 10px; }
        .welcome-guide p { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; }

        /* è¨­å®šãƒ»ãƒ•ã‚©ãƒ¼ãƒ  */
        .modal { background: var(--card); border-radius: 24px 24px 0 0; padding: 25px; box-shadow: 0 -10px 25px rgba(0,0,0,0.05); position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 90vh; overflow-y: auto; }
        .modal.active { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999; display: none; }
        .overlay.active { display: block; }

        input, select { width: 100%; padding: 12px; margin: 8px 0 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; background: #f9fafb; } /* å…¥åŠ›æ¬„ã®èƒŒæ™¯ã‚‚å¾®èª¿æ•´ */
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); }
        
        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.9rem; transition: 0.2s; width: 100%; margin-bottom: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: #f1f5f9; color: var(--text); }
        .btn-danger { background: #fff1f2; color: var(--danger); }
        
        .sync-status { font-size: 0.7rem; text-align: center; color: var(--text-sub); margin-top: 10px; }

        .fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 30px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; z-index: 90; }
    </style>
</head>
<body>

<div class="header">
    <h1>SubTrack</h1>
    <button onclick="toggleModal('settingsModal')" style="background:none; border:none; font-size: 1.2rem;">âš™ï¸</button>
</div>

<div class="container">
    <div id="dashboard" class="dashboard">
        <div class="stat-card">
            <div class="stat-label">æœˆé¡åˆè¨ˆ</div>
            <div id="monthlyTotal" class="stat-value">Â¥0</div>
        </div>
        <div class="stat-card" style="opacity: 0.8;"> <div class="stat-label">å¹´é–“åˆè¨ˆ</div>
            <div id="yearlyTotal" class="stat-value">Â¥0</div>
        </div>
    </div>

    <div id="subList">
        <div id="guide" class="welcome-guide">
            <h2>ã‚ˆã†ã“ãï¼ ğŸ‘‹</h2>
            <p>ã¾ã ã‚µãƒ–ã‚¹ã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å³ä¸Šã®âš™ï¸ã‹ã‚‰åŒæœŸè¨­å®šã‚’ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã‹ã€ä¸‹ã®ã€Œï¼‹ã€ã‹ã‚‰æ–°ã—ã„ã‚µãƒ–ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="btn btn-primary" onclick="toggleModal('settingsModal')">è¨­å®šã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
</div>

<button class="fab" onclick="prepareAdd()">ï¼‹</button>

<div id="subModal" class="modal">
    <h3 id="modalTitle">ã‚µãƒ–ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
    <label>ã‚µãƒ¼ãƒ“ã‚¹å</label>
    <input type="text" id="subName" placeholder="Netflix, iCloudãªã©">
    <label>é‡‘é¡ (Â¥)</label>
    <input type="number" id="subPrice" placeholder="980">
    <label>æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«</label>
    <select id="subCycle">
        <option value="monthly">æ¯æœˆ</option>
        <option value="yearly">æ¯å¹´</option>
    </select>
    <button class="btn btn-primary" onclick="saveSub()">ä¿å­˜</button>
    <button id="deleteBtn" class="btn btn-danger" style="display:none;" onclick="deleteSub()">å‰Šé™¤ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="toggleModal('subModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<div id="settingsModal" class="modal">
    <h3>åŒæœŸè¨­å®š</h3>
    <p style="font-size:0.75rem; color:var(--text-sub); margin-bottom: 20px;">GitHubãƒªãƒã‚¸ãƒˆãƒªã¨æ¥ç¶šã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ã—ã¾ã™ã€‚</p>
    
    <label>GitHub ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
    <input type="text" id="ghUser" placeholder="ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    
    <label>ãƒ‡ãƒ¼ã‚¿ç”¨ãƒªãƒã‚¸ãƒˆãƒªå</label>
    <input type="text" id="ghRepo" placeholder="ä¾‹: my-subsc-data">
    
    <label>ãƒˆãƒ¼ã‚¯ãƒ³ (PAT)</label>
    <input type="password" id="ghToken" placeholder="github_pat_...">
    
    <button class="btn btn-primary" onclick="saveSettings()">åŒæœŸè¨­å®šã‚’ä¿å­˜</button>

    <div id="syncControls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
        <button class="btn btn-sync btn-fetch" onclick="fetchFromGitHub()">
            <svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            èª­è¾¼
        </button>
        <button class="btn btn-sync btn-push" onclick="pushToGitHub()">
            <svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            ä¿å­˜
        </button>
    </div>

    <div id="status" class="sync-status">æœªåŒæœŸ</div>
    <button class="btn btn-ghost" onclick="toggleModal('settingsModal')" style="margin-top: 25px;">é–‰ã˜ã‚‹</button>
</div>
    <div id="status" class="sync-status">æœªåŒæœŸ</div>
    <button class="btn btn-ghost" onclick="toggleModal('settingsModal')" style="margin-top: 20px;">é–‰ã˜ã‚‹</button>
</div>

<div id="overlay" class="overlay" onclick="closeAllModals()"></div>

<script>
    // JavaScriptã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨å…¨ãåŒã˜ã§ã™
    let subs = JSON.parse(localStorage.getItem('subs') || '[]');
    let editingIndex = -1;

    window.onload = () => {
        document.getElementById('ghUser').value = localStorage.getItem('ghUser') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('ghRepo') || '';
        document.getElementById('ghToken').value = localStorage.getItem('ghToken') || '';
        render();
    };

    function render() {
        const list = document.getElementById('subList');
        const guide = document.getElementById('guide');
        list.innerHTML = '';
        
        if (subs.length === 0) {
            list.appendChild(guide);
            updateTotals(0, 0);
            return;
        }

        let mTotal = 0, yTotal = 0;

        subs.forEach((sub, index) => {
            const price = parseInt(sub.price);
            mTotal += (sub.cycle === 'monthly') ? price : Math.round(price / 12);
            yTotal += (sub.cycle === 'yearly') ? price : price * 12;

            const card = document.createElement('div');
            card.className = 'sub-card';
            card.onclick = () => prepareEdit(index);
            card.innerHTML = `
                <div class="sub-info">
                    <div class="name">${sub.name}</div>
                    <div class="cycle">${sub.cycle === 'monthly' ? 'æ¯æœˆæ”¯æ‰•ã„' : 'æ¯å¹´æ”¯æ‰•ã„'}</div>
                </div>
                <div class="sub-price">Â¥${price.toLocaleString()}</div>
            `;
            list.appendChild(card);
        });

        updateTotals(mTotal, yTotal);
    }

    function updateTotals(m, y) {
        document.getElementById('monthlyTotal').innerText = `Â¥${m.toLocaleString()}`;
        document.getElementById('yearlyTotal').innerText = `Â¥${y.toLocaleString()}`;
    }

    function toggleModal(id) {
        document.getElementById(id).classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        document.getElementById('overlay').classList.remove('active');
    }

    function prepareAdd() {
        editingIndex = -1;
        document.getElementById('modalTitle').innerText = 'ã‚µãƒ–ã‚¹ã‚¯ã‚’è¿½åŠ ';
        document.getElementById('subName').value = '';
        document.getElementById('subPrice').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
        toggleModal('subModal');
    }

    function prepareEdit(index) {
        editingIndex = index;
        const sub = subs[index];
        document.getElementById('modalTitle').innerText = 'ç·¨é›†ã™ã‚‹';
        document.getElementById('subName').value = sub.name;
        document.getElementById('subPrice').value = sub.price;
        document.getElementById('subCycle').value = sub.cycle;
        document.getElementById('deleteBtn').style.display = 'block';
        toggleModal('subModal');
    }

    function saveSub() {
        const name = document.getElementById('subName').value;
        const price = document.getElementById('subPrice').value;
        const cycle = document.getElementById('subCycle').value;

        if(!name || !price) return alert('å…¥åŠ›ã—ã¦ãã ã•ã„');

        const newSub = { name, price, cycle };
        if(editingIndex > -1) subs[editingIndex] = newSub;
        else subs.push(newSub);

        saveToLocal();
        closeAllModals();
    }

    function deleteSub() {
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            subs.splice(editingIndex, 1);
            saveToLocal();
            closeAllModals();
        }
    }

    function saveToLocal() {
        localStorage.setItem('subs', JSON.stringify(subs));
        render();
    }

    function saveSettings() {
        localStorage.setItem('ghUser', document.getElementById('ghUser').value);
        localStorage.setItem('ghRepo', document.getElementById('ghRepo').value);
        localStorage.setItem('ghToken', document.getElementById('ghToken').value);
        alert('åŒæœŸè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    async function fetchFromGitHub() {
        const user = localStorage.getItem('ghUser');
        const repo = localStorage.getItem('ghRepo');
        const token = localStorage.getItem('ghToken');
        const status = document.getElementById('status');

        if(!user || !repo || !token) return alert('è¨­å®šãŒè¶³ã‚Šã¾ã›ã‚“');
        status.innerText = 'âŒ› èª­è¾¼ä¸­...';

        try {
            const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/data.json`, {
                headers: { Authorization: `token ${token}` }
            });
            if (!res.ok) throw new Error('èª­è¾¼å¤±æ•—');
            const data = await res.json();
            subs = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            saveToLocal();
            status.innerText = 'âœ… èª­è¾¼æˆåŠŸï¼';
        } catch (e) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            status.innerText = 'âŒ å¤±æ•—';
        }
    }

    async function pushToGitHub() {
        const user = localStorage.getItem('ghUser');
        const repo = localStorage.getItem('ghRepo');
        const token = localStorage.getItem('ghToken');
        const status = document.getElementById('status');

        if(!user || !repo || !token) return alert('è¨­å®šãŒè¶³ã‚Šã¾ã›ã‚“');
        status.innerText = 'âŒ› ä¿å­˜ä¸­...';

        try {
            const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/data.json`, {
                headers: { Authorization: `token ${token}` }
            });
            let sha = '';
            if (res.ok) {
                const data = await res.json();
                sha = data.sha;
            }

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(subs))));
            const putRes = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/data.json`, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Sync subs', content, sha })
            });

            if (putRes.ok) status.innerText = 'âœ… ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å®Œäº†ï¼';
            else throw new Error('ä¿å­˜å¤±æ•—');
        } catch (e) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            status.innerText = 'âŒ å¤±æ•—';
        }
    }
</script>

</body>
</html>
